{% extends "base.html" %}
{% block title %}{{ experiment.name }} — Experiment Logger{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/ui/experiments">Эксперименты</a></li>
    <li class="breadcrumb-item active">{{ experiment.name }}</li>
  </ol>
</nav>

<div class="d-flex align-items-start justify-content-between mb-3">
  <div>
    <h1 class="h3 mb-1">{{ experiment.name }}</h1>
    <div class="text-muted small">
      {% if experiment.stand %}
        <i class="bi bi-cpu me-1"></i>{{ experiment.stand }}
      {% endif %}
      {% if experiment.operator %}
        &nbsp;&bull;&nbsp;<i class="bi bi-person me-1"></i>{{ experiment.operator }}
      {% endif %}
      &nbsp;&bull;&nbsp;<i class="bi bi-calendar3 me-1"></i>{{ experiment.created_at.strftime("%d.%m.%Y %H:%M") }}
    </div>
    {% if experiment.notes %}
    <div class="text-muted small mt-1 fst-italic">{{ experiment.notes }}</div>
    {% endif %}
  </div>
  <a href="/experiments/{{ experiment.id }}/export.csv"
     class="btn btn-sm btn-outline-secondary"
     title="Скачать все данные в CSV">
    <i class="bi bi-download me-1"></i>CSV
  </a>
</div>

<!-- Summary cards -->
<div id="summary-section">
  {% include "partials/summary_cards.html" %}
</div>

<!-- Channels + Chart -->
<div class="row g-4 mb-4">
  <!-- Channels table -->
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between py-2">
        <span class="fw-semibold">Каналы</span>
        <button class="btn btn-sm btn-primary" onclick="buildChart()">
          <i class="bi bi-bar-chart-line me-1"></i>Построить график
        </button>
      </div>
      <div class="card-body p-0 overflow-auto" style="max-height: 460px;">
        <div id="channels-table-wrapper">
          {% include "partials/channels_table.html" %}
        </div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="col-12 col-lg-7">
    <div class="card h-100">
      <div class="card-header py-2 fw-semibold">
        <i class="bi bi-graph-up me-1"></i>График
      </div>
      <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 420px; position: relative;">
        <div id="chart-placeholder" class="text-center text-muted">
          <i class="bi bi-bar-chart-line fs-1 d-block mb-2 opacity-25"></i>
          Выберите каналы и нажмите «Построить график»
        </div>
        <canvas id="myChart" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Import section -->
<div class="card">
  <div class="card-header py-2 fw-semibold">
    <i class="bi bi-upload me-1"></i>Импорт данных
  </div>
  <div class="card-body">
    <div id="import-result"></div>
    <form hx-post="/ui/experiments/{{ experiment.id }}/import"
          hx-encoding="multipart/form-data"
          hx-target="#import-result"
          hx-swap="innerHTML"
          hx-on::after-request="if(event.detail.successful) this.reset();"
          class="row g-2 align-items-end mb-4">
      <div class="col">
        <label class="form-label small text-muted mb-1">CSV или JSONL файл</label>
        <input type="file" name="file" class="form-control form-control-sm" accept=".csv,.jsonl" required>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm">
          <span class="spinner-border spinner-border-sm htmx-indicator me-1"></span>
          <i class="bi bi-cloud-upload me-1"></i>Загрузить
        </button>
      </div>
    </form>

    <h6 class="text-muted mb-2 small text-uppercase">История импортов</h6>
    <div id="import-history">
      {% include "partials/import_history.html" %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
  const EXPERIMENT_ID = {{ experiment.id }};
  const CHART_COLORS = [
    '#3b82f6', '#ef4444', '#10b981', '#f59e0b',
    '#8b5cf6', '#06b6d4', '#f97316', '#ec4899'
  ];
  let chart = null;

  async function buildChart() {
    const checkboxes = document.querySelectorAll('.channel-checkbox:checked');
    const channels = Array.from(checkboxes).map(cb => cb.value);
    if (channels.length === 0) {
      alert('Выберите хотя бы один канал');
      return;
    }

    const params = new URLSearchParams();
    channels.forEach(ch => params.append('channels', ch));

    let data;
    try {
      const resp = await fetch(`/experiments/${EXPERIMENT_ID}/series?${params}`);
      data = await resp.json();
    } catch (e) {
      console.error('Series fetch failed', e);
      return;
    }

    const datasets = channels
      .filter(ch => data[ch] && data[ch].length > 0)
      .map((ch, i) => ({
        label: ch,
        data: data[ch].map(p => ({ x: p.timestamp, y: p.value })),
        borderColor: CHART_COLORS[i % CHART_COLORS.length],
        backgroundColor: CHART_COLORS[i % CHART_COLORS.length] + '22',
        tension: 0.2,
        pointRadius: data[ch].length > 200 ? 0 : 4,
        fill: false,
        borderWidth: 2,
      }));

    if (datasets.length === 0) {
      alert('Нет данных по выбранным каналам');
      return;
    }

    const placeholder = document.getElementById('chart-placeholder');
    const canvas = document.getElementById('myChart');
    placeholder.style.display = 'none';
    canvas.style.display = 'block';

    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
    const tickColor = isDark ? '#adb5bd' : '#6c757d';

    if (chart) {
      chart.data.datasets = datasets;
      chart.update();
    } else {
      chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              type: 'time',
              time: {
                displayFormats: {
                  second: 'HH:mm:ss',
                  minute: 'HH:mm',
                  hour: 'HH:mm',
                  day: 'dd.MM',
                }
              },
              grid: { color: gridColor },
              ticks: { color: tickColor, maxTicksLimit: 8 },
              title: { display: true, text: 'Время', color: tickColor }
            },
            y: {
              grid: { color: gridColor },
              ticks: { color: tickColor },
              title: { display: true, text: 'Значение', color: tickColor }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: { color: isDark ? '#dee2e6' : '#212529', usePointStyle: true }
            },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }
  }

  // Rebuild chart with updated theme colors on toggle
  document.getElementById('theme-btn')?.addEventListener('click', function () {
    if (chart) {
      setTimeout(() => {
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        const tickColor = isDark ? '#adb5bd' : '#6c757d';
        const legendColor = isDark ? '#dee2e6' : '#212529';
        chart.options.scales.x.grid.color = gridColor;
        chart.options.scales.x.ticks.color = tickColor;
        chart.options.scales.x.title.color = tickColor;
        chart.options.scales.y.grid.color = gridColor;
        chart.options.scales.y.ticks.color = tickColor;
        chart.options.scales.y.title.color = tickColor;
        chart.options.plugins.legend.labels.color = legendColor;
        chart.update();
      }, 50);
    }
  });
</script>
{% endblock %}
